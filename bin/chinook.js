#!/usr/bin/env node
// Generated by CoffeeScript 1.7.1
(function() {
  var Chinook, addAddress, argv, async, command, connectToRedis, docker, ensureHostname, exports, getFirstPort, hostnameKey, hostname_key_prefix, makeAddress, printAddresses, printAllAddresses, redis, redis_address, redis_host, redis_port, removeAddress, util, _, _hostname, _id, _new_id, _old_id, _printAddresses;

  util = require('util');

  docker = new require('dockerode')({
    socketPath: '/var/run/docker.sock'
  });

  _ = require('underscore');

  argv = require('minimist')(process.argv);

  async = require('async');

  redis_address = (argv.redis || argv.r || 'localhost:6379').split(':');

  redis_host = redis_address[0];

  redis_port = redis_address[1];

  redis = null;

  connectToRedis = function(cb) {
    redis = require('redis').createClient(redis_port, redis_host);
    redis.on('ready', function() {
      return cb();
    });
    return redis.on('error', function() {
      console.log("[ERROR] Could not connect to Redis at " + (redis_address.join(':')));
      return process.exit();
    });
  };

  getFirstPort = function(net) {
    return _.keys(net.Ports)[0].split('/')[0];
  };

  makeAddress = function(net) {
    return 'http://' + net.IPAddress + ':' + getFirstPort(net);
  };

  hostname_key_prefix = 'frontend:';

  hostnameKey = function(hostname) {
    return hostname_key_prefix + hostname;
  };

  ensureHostname = function(hostname, cb) {
    return redis.llen(hostnameKey(hostname), function(err, l) {
      if (l < 2) {
        return redis.rpush(hostnameKey(hostname), cb);
      } else {
        return cb();
      }
    });
  };

  addAddress = function(hostname, address, cb) {
    return removeAddress(hostname, address, function() {
      return redis.rpush(hostnameKey(hostname), address, cb);
    });
  };

  removeAddress = function(hostname, address, cb) {
    return redis.lrem(hostnameKey(hostname), 0, address, cb);
  };

  printAddresses = function(hostname, cb) {
    return _printAddresses(hostname, function(err, output) {
      console.log(output);
      return cb();
    });
  };

  _printAddresses = function(hostname, cb) {
    return redis.lrange(hostnameKey(hostname), 1, -1, function(err, addresses) {
      var address, output, _i, _len;
      output = '';
      output += 'HOSTNAME: ' + hostname;
      for (_i = 0, _len = addresses.length; _i < _len; _i++) {
        address = addresses[_i];
        output += '\n    ----> ' + address;
      }
      return cb(null, output);
    });
  };

  printAllAddresses = function(cb) {
    return redis.keys(hostnameKey('*'), function(err, hostname_keys) {
      return async.mapSeries(hostname_keys, function(hk, _cb) {
        var h;
        h = hk.replace(RegExp('^' + hostname_key_prefix), '');
        return _printAddresses(h, _cb);
      }, function(err, outputs) {
        console.log(outputs.join('\n\n'));
        return cb();
      });
    });
  };

  Chinook = {};

  Chinook.attachContainer = function(container_id, hostname, cb) {
    return docker.getContainer(container_id).inspect(function(err, container) {
      var container_address;
      if (err) {
        console.log(err);
      }
      container_address = makeAddress(container.NetworkSettings);
      console.log('  ATTACH: [' + container_id + '] = ' + container_address);
      return ensureHostname(hostname, function() {
        return addAddress(hostname, container_address, cb);
      });
    });
  };

  Chinook.detachContainer = function(container_id, hostname, cb) {
    return docker.getContainer(container_id).inspect(function(err, container) {
      var container_address;
      if (err) {
        console.log(err);
      }
      container_address = makeAddress(container.NetworkSettings);
      console.log('  DETACH: [' + container_id + '] = ' + container_address);
      return ensureHostname(hostname, function() {
        return removeAddress(hostname, container_address, cb);
      });
    });
  };

  Chinook.replaceContainer = function(old_container_id, new_container_id, hostname, cb) {
    return docker.getContainer(old_container_id).inspect(function(err, old_container) {
      var old_container_address;
      if (err) {
        console.log(err);
      }
      old_container_address = makeAddress(old_container.NetworkSettings);
      console.log('  DETACH: [' + old_container_id + '] = ' + old_container_address);
      return docker.getContainer(new_container_id).inspect(function(err, new_container) {
        var new_container_address;
        if (err) {
          console.log(err);
        }
        new_container_address = makeAddress(new_container.NetworkSettings);
        console.log('  ATTACH: [' + new_container_id + '] = ' + new_container_address);
        return ensureHostname(hostname, function() {
          return removeAddress(hostname, old_container_address, function() {
            return addAddress(hostname, new_container_address, cb);
          });
        });
      });
    });
  };

  Chinook.clearHostname = function(hostname, cb) {
    return redis.del(hostnameKey(hostname), cb);
  };

  if (require.main !== module) {
    exports = Chinook;
    console.log('TODO: Attach connected redis client to exported chinook context');
  } else {
    command = argv._[2];
    if (command === 'launch') {
      console.error("NOT IMPLEMENTED");
      process.exit();
    } else if (command === 'replace') {
      _old_id = argv._[3];
      _new_id = argv._[4];
      _hostname = argv._[5] || argv.hostname || argv.h;
      console.log("Replacing container " + _old_id + " with " + _new_id + " for " + _hostname + "...");
      connectToRedis(function() {
        return Chinook.replaceContainer(_old_id, _new_id, _hostname, function() {
          return printAddresses(_hostname, function() {
            return process.exit();
          });
        });
      });
    } else if (command === 'attach') {
      _id = argv._[3];
      _hostname = argv._[4] || argv.hostname || argv.hostname || argv.h;
      console.log("Attaching container " + _id + " to " + _hostname + "...");
      connectToRedis(function() {
        return Chinook.attachContainer(_id, _hostname, function() {
          return printAddresses(_hostname, function() {
            return process.exit();
          });
        });
      });
    } else if (command === 'detach') {
      _id = argv._[3];
      _hostname = argv._[4] || argv.hostname || argv.h;
      console.log("Detaching container " + _id + " from " + _hostname + "...");
      connectToRedis(function() {
        return Chinook.detachContainer(_id, _hostname, function() {
          return printAddresses(_hostname, function() {
            return process.exit();
          });
        });
      });
    } else if (command === 'clear') {
      _hostname = argv._[3];
      connectToRedis(function() {
        return Chinook.clearHostname(_hostname, function() {
          return printAllAddresses(function() {
            return process.exit();
          });
        });
      });
    } else {
      connectToRedis(function() {
        return printAllAddresses(function() {
          return process.exit();
        });
      });
    }
  }

}).call(this);
